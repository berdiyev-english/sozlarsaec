<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Озвучка тест</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 20px;
      max-width: 600px;
      margin-inline: auto;
      background: #f5f5f5;
    }
    h1 {
      font-size: 22px;
      margin-bottom: 12px;
      text-align: center;
    }
    p {
      font-size: 14px;
      color: #555;
      margin-bottom: 10px;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: #fff;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }
    input[type="text"] {
      font-size: 18px;
      padding: 8px 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    select {
      font-size: 14px;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      max-width: 100%;
    }
    label {
      font-size: 14px;
      color: #333;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    input[type="range"] {
      width: 100%;
    }
    button {
      font-size: 16px;
      padding: 10px 14px;
      border-radius: 4px;
      border: none;
      background: #007bff;
      color: #fff;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .status {
      margin-top: 6px;
      font-size: 13px;
      color: #555;
      min-height: 18px;
    }
    .warning {
      font-size: 12px;
      color: #888;
      margin-top: 8px;
    }
    .small {
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>Озвучка английских слов</h1>

  <p>
    Введите слово/фразу на английском, выберите голос (Google / Microsoft и др.) и скорость, затем нажмите «Озвучить».
  </p>

  <form id="ttsForm">
    <input
      id="textInput"
      type="text"
      placeholder="Например: pronunciation"
      autocomplete="off"
      required
    />

    <label>
      Голос:
      <select id="voiceSelect">
        <option value="">Загрузка списка голосов...</option>
      </select>
      <span id="voiceInfo" class="small"></span>
    </label>

    <label>
      Скорость: <span id="rateValue">1.0</span>
      <input
        id="rate"
        type="range"
        min="0.5"
        max="2"
        step="0.1"
        value="1"
      />
    </label>

    <button type="submit" id="speakBtn">Озвучить</button>
    <div class="status" id="status"></div>
    <div class="warning">
      Голоса берутся из вашего браузера/системы:
      Google‑голоса будут видны в основном в Chrome (как, например, «Google US English»).
      Через один HTML‑файл нельзя установить новые голоса — только использовать те, что уже есть.
    </div>
  </form>

  <script>
    const form = document.getElementById('ttsForm');
    const input = document.getElementById('textInput');
    const statusEl = document.getElementById('status');
    const speakBtn = document.getElementById('speakBtn');
    const voiceSelect = document.getElementById('voiceSelect');
    const voiceInfo = document.getElementById('voiceInfo');
    const rateInput = document.getElementById('rate');
    const rateValue = document.getElementById('rateValue');

    // Проверяем поддержку Web Speech API
    if (!('speechSynthesis' in window)) {
      statusEl.textContent =
        'Ваш браузер не поддерживает озвучку (SpeechSynthesis). ' +
        'Попробуйте Chrome, Edge или Safari.';
      speakBtn.disabled = true;
      voiceSelect.disabled = true;
    }

    let voices = [];
    let voicesLoaded = false;

    function populateVoices() {
      const list = window.speechSynthesis.getVoices();
      if (!list || !list.length) return;

      voices = list;
      voicesLoaded = true;

      voiceSelect.innerHTML = '';

      // Разделяем голоса по «поставщику» по имени (Google, Microsoft, другие)
      const googleVoices = voices.filter(v =>
        v.name.toLowerCase().includes('google')
      );
      const microsoftVoices = voices.filter(v =>
        v.name.toLowerCase().includes('microsoft')
      );
      const otherVoices = voices.filter(v =>
        !v.name.toLowerCase().includes('google') &&
        !v.name.toLowerCase().includes('microsoft')
      );

      // Сортируем внутри групп по языку+имени
      function sortGroup(arr) {
        return arr.sort((a, b) =>
          (a.lang + a.name).localeCompare(b.lang + b.name)
        );
      }

      const sorted = [
        ...sortGroup(googleVoices),      // сначала Google
        ...sortGroup(microsoftVoices),   // потом Microsoft
        ...sortGroup(otherVoices)        // потом остальные
      ];

      let selectedIndex = 0;

      sorted.forEach((voice, index) => {
        const option = document.createElement('option');
        let vendorTag = '';

        const lowerName = voice.name.toLowerCase();
        if (lowerName.includes('google')) {
          vendorTag = '[Google] ';
        } else if (lowerName.includes('microsoft')) {
          vendorTag = '[Microsoft] ';
        }

        option.value = voice.name;
        option.textContent =
          vendorTag +
          `${voice.name} (${voice.lang})` +
          (voice.default ? ' [default]' : '');

        // Если это английский голос, попробуем сделать его выбранным по умолчанию
        if (voice.lang.toLowerCase().startsWith('en') && selectedIndex === 0) {
          selectedIndex = index;
        }

        voiceSelect.appendChild(option);
      });

      voiceSelect.selectedIndex = selectedIndex;

      voiceInfo.textContent =
        `Всего голосов: ${voices.length}. ` +
        `Google‑голоса (если есть) идут первыми в списке.`;
    }

    if ('speechSynthesis' in window) {
      window.speechSynthesis.addEventListener('voiceschanged', () => {
        if (!voicesLoaded) populateVoices();
      });
      populateVoices();
    }

    rateInput.addEventListener('input', () => {
      rateValue.textContent = rateInput.value;
    });

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;
      if (!('speechSynthesis' in window)) return;

      // Останавливаем текущую озвучку
      window.speechSynthesis.cancel();

      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'en-US'; // базовый язык

      // скорость
      utterance.rate = parseFloat(rateInput.value) || 1.0;
      utterance.pitch = 1.0;

      const selectedName = voiceSelect.value;
      if (selectedName && voices && voices.length) {
        const voice = voices.find(v => v.name === selectedName);
        if (voice) {
          utterance.voice = voice;
          if (voice.lang) {
            utterance.lang = voice.lang;
          }
        }
      }

      speakBtn.disabled = true;
      statusEl.textContent = 'Воспроизведение...';

      utterance.onend = () => {
        speakBtn.disabled = false;
        statusEl.textContent = 'Готово.';
      };

      utterance.onerror = (event) => {
        console.error(event);
        speakBtn.disabled = false;
        statusEl.textContent = 'Ошибка при озвучивании.';
      };

      window.speechSynthesis.speak(utterance);
    });
  </script>
</body>
</html>
