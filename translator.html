<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Bewords Translator</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

        :root{
            --duo-green: #58CC02;
            --duo-green-dark: #45A800;
            --duo-blue: #1CB0F6;
            --duo-blue-dark: #1292D9;
            --duo-yellow: #FFD966;
            --duo-red: #EA2B2B;
            --bg: #F5F9FF;
            --text: #2E3A44;
            --muted: #6B7C93;
            --card: #FFFFFF;
            --border: #E6ECF5;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(180deg, #F2FFE8 0%, #FFFFFF 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--card);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.06);
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .header {
            background: linear-gradient(135deg, var(--duo-green) 0%, var(--duo-green-dark) 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.95;
            font-size: 14px;
        }

        .input-section {
            padding: 24px 30px 30px;
            background: #FBFEFF;
            border-bottom: 1px solid var(--border);
        }

        .lang-selector {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 18px;
            justify-content: center;
        }

        .lang-btn {
            padding: 10px 18px;
            background: white;
            border: 2px solid var(--border);
            border-radius: 999px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.2s;
            color: var(--text);
            font-size: 14px;
        }

        .lang-btn:hover {
            border-color: var(--duo-blue);
        }

        .lang-btn.active {
            background: var(--duo-blue);
            color: white;
            border-color: var(--duo-blue);
            box-shadow: 0 6px 16px rgba(28,176,246,0.25);
        }

        .swap-btn {
            background: white;
            color: var(--duo-green);
            border: 2px solid var(--duo-green);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            transition: transform 0.3s, background 0.2s;
            flex-shrink: 0;
        }
        .swap-btn:hover { transform: rotate(180deg); background: #F3FFEC; }

        .input-group {
            display: flex;
            gap: 10px;
        }

        .input-field {
            flex: 1;
            padding: 15px 16px;
            border: 2px solid var(--border);
            border-radius: 14px;
            font-size: 16px;
            background: #fff;
            transition: border 0.2s, box-shadow 0.2s;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--duo-green);
            box-shadow: 0 0 0 4px rgba(88,204,2,0.15);
        }

        .translate-btn {
            padding: 15px 24px;
            background: linear-gradient(135deg, var(--duo-green) 0%, var(--duo-green-dark) 100%);
            color: white;
            border: none;
            border-radius: 14px;
            font-weight: 800;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.2s;
            box-shadow: 0 8px 18px rgba(88,204,2,0.25);
            white-space: nowrap;
        }
        .translate-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 22px rgba(88,204,2,0.33);
        }

        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }
        .loading.active { display: block; }

        .spinner {
            width: 46px;
            height: 46px;
            border: 4px solid #EEF3F7;
            border-top: 4px solid var(--duo-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 14px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .results-section { padding: 28px; display: none; }
        .results-section.active { display: block; }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 14px;
            margin-bottom: 22px;
        }

        .stat-card {
            background: linear-gradient(135deg, #DFF7C2, #CFF0FF);
            color: #204050;
            padding: 18px;
            border-radius: 14px;
            text-align: center;
            border: 1px solid #E4F3FF;
        }

        .stat-number { font-size: 28px; font-weight: 800; }
        .stat-label { font-size: 12px; opacity: 0.85; }

        .main-translation {
            background: #F8FFF2;
            padding: 22px;
            border-radius: 14px;
            margin-bottom: 24px;
            border-left: 5px solid var(--duo-green);
        }

        .original-text {
            font-size: 22px;
            font-weight: 800;
            color: var(--text);
            margin-bottom: 8px;
        }

        .main-result {
            font-size: 22px;
            color: var(--duo-green);
            font-weight: 800;
        }

        .section-title {
            font-size: 18px;
            font-weight: 800;
            margin: 18px 0 14px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .count-badge {
            background: var(--duo-blue);
            color: white;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 700;
        }

        .translations-grid {
            display: grid;
            gap: 14px;
            margin-bottom: 8px;
        }

        .translation-group {
            background: white;
            border: 1px solid var(--border);
            border-radius: 14px;
            overflow: hidden;
        }

        .group-header {
            background: #F9FBFF;
            padding: 14px;
            font-weight: 700;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text);
            flex-wrap: wrap;
            gap: 8px;
        }

        .translation-list { padding: 14px; }

        .translation-item {
            padding: 12px;
            margin-bottom: 10px;
            background: #FAFFFB;
            border: 1px solid #EAF6EC;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 14px;
            flex-wrap: wrap;
        }

        .translation-item:hover {
            background: #F1FFEA;
            transform: translateX(4px);
        }

        .translation-number {
            min-width: 32px;
            height: 32px;
            background: var(--duo-green);
            color: white;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 14px;
            flex-shrink: 0;
        }

        .translation-text { font-weight: 600; color: var(--text); }
        .translation-info { font-size: 12px; color: var(--muted); margin-top: 2px; }

        .context-examples { margin-top: 24px; }

        .example-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 12px;
        }

        .example-source {
            color: var(--text);
            margin-bottom: 8px;
            padding-bottom: 10px;
            border-bottom: 1px dashed var(--border);
        }

        .example-target { color: var(--muted); }

        .highlight {
            background: var(--duo-yellow);
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 800;
        }

        .error-message {
            background: var(--duo-red);
            color: white;
            padding: 14px;
            border-radius: 12px;
            text-align: center;
            display: none;
            margin: 10px 20px;
        }
        .error-message.active { display: block; }

        .examples-loading {
            text-align: center;
            color: var(--muted);
            padding: 12px 0 6px;
            font-size: 14px;
        }

        .examples-empty, .examples-error {
            text-align: center;
            color: var(--muted);
            padding: 10px 0;
            font-size: 14px;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .add-btn {
            padding: 6px 10px;
            background: #fff;
            border: 2px solid var(--duo-green);
            color: var(--duo-green);
            border-radius: 999px;
            font-weight: 800;
            font-size: 12px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.15s;
            flex-shrink: 0;
        }
        .add-btn:hover { background: #F3FFEC; }
        .add-btn.added {
            background: var(--duo-green);
            color: #fff;
            border-color: var(--duo-green);
            pointer-events: none;
        }
        .main-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        /* ============= –ú–û–ë–ò–õ–¨–ù–ê–Ø –ê–î–ê–ü–¢–ê–¶–ò–Ø ============= */
        
        /* –ü–ª–∞–Ω—à–µ—Ç—ã –∏ –º–∞–ª–µ–Ω—å–∫–∏–µ –Ω–æ—É—Ç–±—É–∫–∏ */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                border-radius: 16px;
            }

            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 24px;
                margin-bottom: 6px;
            }

            .header p {
                font-size: 13px;
            }

            .input-section {
                padding: 18px 15px 20px;
            }

            .stats {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 10px;
            }

            .stat-card {
                padding: 14px;
            }

            .stat-number {
                font-size: 24px;
            }

            .results-section {
                padding: 20px 15px;
            }
        }

        /* –°–º–∞—Ä—Ç—Ñ–æ–Ω—ã */
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }

            .container {
                border-radius: 12px;
            }

            .header {
                padding: 16px 12px;
            }

            .header h1 {
                font-size: 20px;
                margin-bottom: 4px;
                line-height: 1.2;
            }

            .header p {
                font-size: 11px;
                line-height: 1.3;
            }

            .input-section {
                padding: 14px 12px 16px;
            }

            .lang-selector {
                gap: 8px;
                margin-bottom: 14px;
            }

            .lang-btn {
                padding: 8px 12px;
                font-size: 12px;
                white-space: nowrap;
            }

            .swap-btn {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }

            /* –ì–õ–ê–í–ù–û–ï: –¥–µ–ª–∞–µ–º input-group –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–º */
            .input-group {
                flex-direction: column;
                gap: 10px;
            }

            .input-field {
                width: 100%;
                padding: 12px 14px;
                font-size: 16px; /* –ú–∏–Ω–∏–º—É–º 16px –¥–ª—è iOS, —á—Ç–æ–±—ã –Ω–µ –∑—É–º–∏–ª–æ */
            }

            .translate-btn {
                width: 100%;
                padding: 14px 20px;
                font-size: 15px;
            }

            .results-section {
                padding: 16px 12px;
            }

            .stats {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .stat-card {
                padding: 12px;
            }

            .stat-number {
                font-size: 22px;
            }

            .stat-label {
                font-size: 11px;
            }

            .main-translation {
                padding: 16px;
                margin-bottom: 18px;
            }

            .original-text {
                font-size: 18px;
                margin-bottom: 6px;
            }

            .main-result {
                font-size: 18px;
            }

            .section-title {
                font-size: 16px;
                margin: 14px 0 10px;
            }

            .count-badge {
                font-size: 12px;
                padding: 3px 8px;
            }

            .group-header {
                padding: 12px;
                font-size: 14px;
            }

            .translation-list {
                padding: 10px;
            }

            .translation-item {
                padding: 10px;
                gap: 10px;
            }

            .translation-number {
                min-width: 28px;
                height: 28px;
                font-size: 12px;
            }

            .translation-text {
                font-size: 14px;
            }

            .translation-info {
                font-size: 11px;
            }

            .add-btn {
                padding: 5px 8px;
                font-size: 11px;
            }

            .example-card {
                padding: 12px;
                font-size: 14px;
            }

            .loading {
                padding: 30px 15px;
            }

            .spinner {
                width: 40px;
                height: 40px;
            }

            .error-message {
                margin: 8px 12px;
                padding: 12px;
                font-size: 13px;
            }
        }

        /* –û—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–µ —ç–∫—Ä–∞–Ω—ã */
        @media (max-width: 360px) {
            .header h1 {
                font-size: 18px;
            }

            .header p {
                font-size: 10px;
            }

            .lang-btn {
                padding: 7px 10px;
                font-size: 11px;
            }

            .swap-btn {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }

            .original-text,
            .main-result {
                font-size: 16px;
            }

            .translation-text {
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>Bewords Translator</h1>
        <p>–ò—â–∏—Ç–µ —Å–ª–æ–≤–∞ –∏ —Ñ—Ä–∞–∑—ã –∏ –¥–æ–±–∞–≤–ª—è–π—Ç–µ –∏—Ö –Ω–∞ –∏–∑—É—á–µ–Ω–∏–µ</p>
    </div>

    <div class="input-section">
        <div class="lang-selector">
            <button class="lang-btn active" id="ruBtn" onclick="setLang('ru', 'en')">üá∑üá∫ –†—É—Å—Å–∫–∏–π</button>
            <button class="swap-btn" onclick="swapLangs()" title="–ü–æ–º–µ–Ω—è—Ç—å –º–µ—Å—Ç–∞–º–∏">‚áÑ</button>
            <button class="lang-btn" id="enBtn" onclick="setLang('en', 'ru')">üá¨üáß English</button>
        </div>

        <div class="input-group">
            <input type="text"
                   class="input-field"
                   id="inputText"
                   placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ –∏–ª–∏ —Ñ—Ä–∞–∑—É..."
                   onkeypress="if(event.key === 'Enter') translateAll()">
            <button class="translate-btn" onclick="translateAll()">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏</button>
        </div>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–µ—Ä–µ–≤–æ–¥–∞...</p>
    </div>

    <div class="error-message" id="error"></div>

    <div class="results-section" id="results"></div>
</div>

<script>
    let sourceLang = 'ru';
    let targetLang = 'en';

    const ruButton = document.getElementById('ruBtn');
    const enButton = document.getElementById('enBtn');
    const swapButton = document.querySelector('.swap-btn');

    ruButton.style.order = '1';
    swapButton.style.order = '2';
    enButton.style.order = '3';

    function setLang(from, to) {
        sourceLang = from;
        targetLang = to;

        document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
        if (from === 'ru') {
            document.getElementById('ruBtn').classList.add('active');
        } else {
            document.getElementById('enBtn').classList.add('active');
        }
    }

    function swapLangs() {
        if (sourceLang === 'ru') {
            setLang('en', 'ru');
        } else {
            setLang('ru', 'en');
        }

        const tempOrder = ruButton.style.order;
        ruButton.style.order = enButton.style.order;
        enButton.style.order = tempOrder;
    }

    async function translateAll() {
        const text = document.getElementById('inputText').value.trim();
        if (!text) { showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞'); return; }

        document.getElementById('error').classList.remove('active');
        document.getElementById('results').classList.remove('active');
        document.getElementById('loading').classList.add('active');

        try {
            const allTranslations = await getAllTranslations(text);
            await displayResults(text, allTranslations);
        } catch (error) {
            console.error('Error:', error);
            showError('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
        } finally {
            document.getElementById('loading').classList.remove('active');
        }
    }

    async function getAllTranslations(text) {
        const translations = [];
        const uniqueTranslations = new Set();

        try {
            const googleUrl = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sourceLang}&tl=${targetLang}&dt=t&dt=bd&dt=ex&dt=ld&dt=md&dt=qca&dt=rw&dt=rm&dt=ss&dt=at&q=${encodeURIComponent(text)}`;
            const response = await fetch(googleUrl);
            const data = await response.json();

            if (Array.isArray(data[0])) {
                let mainTranslation = '';
                data[0].forEach(item => { if (item[0]) mainTranslation += item[0]; });
                if (mainTranslation && !uniqueTranslations.has(mainTranslation.toLowerCase())) {
                    translations.push({ text: mainTranslation, type: '–æ—Å–Ω–æ–≤–Ω–æ–π', source: 'Google', confidence: 100 });
                    uniqueTranslations.add(mainTranslation.toLowerCase());
                }
            }

            if (Array.isArray(data[1])) {
                data[1].forEach(group => {
                    const partOfSpeech = group[0];
                    if (Array.isArray(group[1])) {
                        group[1].forEach((word, index) => {
                            if (word && !uniqueTranslations.has(word.toLowerCase())) {
                                translations.push({
                                    text: word, type: partOfSpeech || '–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π',
                                    source: 'Google Dictionary', confidence: Math.max(50, 90 - index * 5)
                                });
                                uniqueTranslations.add(word.toLowerCase());
                            }
                        });
                    }
                    if (Array.isArray(group[2])) {
                        group[2].forEach(item => {
                            if (Array.isArray(item[1])) {
                                item[1].forEach((synonym, idx) => {
                                    if (synonym && !uniqueTranslations.has(synonym.toLowerCase())) {
                                        translations.push({
                                            text: synonym, type: '—Å–∏–Ω–æ–Ω–∏–º',
                                            source: 'Google', confidence: Math.max(40, 70 - idx * 5)
                                        });
                                        uniqueTranslations.add(synonym.toLowerCase());
                                    }
                                });
                            }
                        });
                    }
                });
            }

            if (data[5] && data[5][0] && Array.isArray(data[5][0][2])) {
                data[5][0][2].forEach(item => {
                    if (item[0] && !uniqueTranslations.has(item[0].toLowerCase())) {
                        translations.push({ text: item[0], type: '–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π', source: 'Google', confidence: 60 });
                        uniqueTranslations.add(item[0].toLowerCase());
                    }
                });
            }
        } catch (e) {
            console.error('Google Translate error:', e);
        }

        try {
            const myMemoryUrl = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${sourceLang}|${targetLang}`;
            const response = await fetch(myMemoryUrl);
            const data = await response.json();

            if (data.responseData && data.responseData.translatedText) {
                const tr = data.responseData.translatedText;
                if (tr && !uniqueTranslations.has(tr.toLowerCase())) {
                    translations.push({ text: tr, type: '–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π', source: 'MyMemory', confidence: 85 });
                    uniqueTranslations.add(tr.toLowerCase());
                }
            }

            if (Array.isArray(data.matches)) {
                data.matches.forEach((match, index) => {
                    const tr = match.translation;
                    if (tr && !uniqueTranslations.has(tr.toLowerCase())) {
                        translations.push({
                            text: tr, type: '–≤–∞—Ä–∏–∞–Ω—Ç',
                            source: 'MyMemory DB', confidence: Math.max(45, 80 - index * 5)
                        });
                        uniqueTranslations.add(tr.toLowerCase());
                    }
                });
            }
        } catch (e) {
            console.error('MyMemory error:', e);
        }

        translations.sort((a, b) => b.confidence - a.confidence);
        return translations;
    }

    function escapeHTML(str='') {
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }

    function escapeRegExp(str='') {
        return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function highlightTerm(text='', term='') {
        if (!term) return text;
        const pattern = new RegExp(`(${escapeRegExp(term)})`, 'gi');
        return text.replace(pattern, '<span class="highlight">$1</span>');
    }

    const STUDY_STORAGE_KEY = 'bewords_study_list';

    function showToast(message, bg = 'var(--duo-green)') {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: ${bg};
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.12);
            z-index: 1000;
            animation: slideIn 0.3s ease;
            font-weight: 700;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 1800);
    }

    function getStudySet() {
        try {
            const list = JSON.parse(localStorage.getItem(STUDY_STORAGE_KEY) || '[]');
            return new Set(list.map(i => (i.term || '').toLowerCase()));
        } catch {
            return new Set();
        }
    }

    async function addToStudy(term, meta = {}) {
        if (!term || !/[A-Za-z]/.test(term)) {
            showToast('–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –∞–Ω–≥–ª. —Å–ª–æ–≤–∞/—Ñ—Ä–∞–∑—ã', 'var(--duo-red)');
            return false;
        }

        const payload = { term: term.trim(), lang: 'en', ...meta };
        try {
            if (typeof window.onAddToStudy === 'function') {
                await window.onAddToStudy(payload);
            } else if (window.studyClient?.addTerm) {
                await window.studyClient.addTerm(payload);
            } else {
                const list = JSON.parse(localStorage.getItem(STUDY_STORAGE_KEY) || '[]');
                if (!list.some(i => (i.term || '').toLowerCase() === payload.term.toLowerCase())) {
                    list.push({ term: payload.term, meta: payload, ts: Date.now() });
                    localStorage.setItem(STUDY_STORAGE_KEY, JSON.stringify(list));
                }
            }

            window.dispatchEvent(new CustomEvent('bewords:add', { detail: payload }));
            showToast(`–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–∑—É—á–µ–Ω–∏–µ: ${payload.term}`);
            return true;
        } catch (err) {
            console.error('addToStudy error', err);
            showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑', 'var(--duo-red)');
            return false;
        }
    }

    function handleAddClick(e) {
        e.stopPropagation();
        const btn = e.currentTarget;
        const term = decodeURIComponent(btn.dataset.term || '');
        if (!term) return;

        const meta = {
            sourceLang,
            targetLang,
            originalText: decodeURIComponent(btn.dataset.original || ''),
            chosenText: decodeURIComponent(btn.dataset.chosen || term),
            source: decodeURIComponent(btn.dataset.source || 'UI'),
            confidence: btn.dataset.confidence ? Number(btn.dataset.confidence) : undefined,
            where: btn.dataset.where || 'list',
            ts: Date.now()
        };

        addToStudy(term, meta).then(success => {
            if (success) {
                btn.classList.add('added');
                btn.textContent = '‚úì –î–æ–±–∞–≤–ª–µ–Ω–æ';
            }
        });
    }

function mapToTatoebaLang(code2) {
    if (code2 === 'en') return 'eng';
    if (code2 === 'ru') return 'rus';
    return 'eng';
}

   async function getRealExamples(originalText, mainTranslation) {
    const from3 = mapToTatoebaLang(sourceLang);
    const to3 = mapToTatoebaLang(targetLang);

    // –ó–∞–ø—Ä–æ—Å –∫ Tatoeba
    const apiUrl =
        `https://tatoeba.org/en/api_v0/search?from=${from3}&to=${to3}` +
        `&query=${encodeURIComponent(originalText)}` +
        `&orphans=no&unapproved=no&has_audio=no&sort=relevance&sort_reverse=&page=1&per_page=10`;

    // CORS‚Äë–ø—Ä–æ–∫—Å–∏ (—á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–æ –ø—Ä—è–º–æ –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞ –±–µ–∑ –±—ç–∫–µ–Ω–¥–∞)
    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(apiUrl)}`;

    try {
        const res = await fetch(proxyUrl);
        const wrapped = await res.json();
        const data = JSON.parse(wrapped.contents);

        const results = Array.isArray(data.results) ? data.results : [];
        const examples = [];

        for (const item of results) {
            const src = item.text || '';
            let tgt = '(–ø–µ—Ä–µ–≤–æ–¥ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)';

            // –ë–µ—Ä—ë–º –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ (Tatoeba —É–∂–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–ª–∞ –ø–æ —è–∑—ã–∫—É to=...)
            if (item.translations && item.translations.length > 0 && item.translations[0].length > 0) {
                tgt = item.translations[0][0].text || tgt;
            }

            const srcEsc = escapeHTML(src);
            const tgtEsc = escapeHTML(tgt);

            // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å –≤ –∏—Å—Ö–æ–¥–Ω–æ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏
            const srcHi = highlightTerm(srcEsc, originalText);

            // –í –ø–µ—Ä–µ–≤–æ–¥–µ –º–æ–∂–Ω–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π –ø–µ—Ä–µ–≤–æ–¥ (–µ—Å–ª–∏ –µ—Å—Ç—å)
            let tgtHi = tgtEsc;
            if (mainTranslation && tgt.toLowerCase().includes(mainTranslation.toLowerCase())) {
                tgtHi = highlightTerm(tgtEsc, mainTranslation);
            }

            examples.push({
                source: srcHi,
                target: tgtHi
            });
        }

        return examples;
    } catch (e) {
        console.error('Tatoeba error:', e);
        return [];
    }
}

    async function displayResults(originalText, translations) {
        const resultsDiv = document.getElementById('results');
        const studySet = getStudySet();

        const grouped = {};
        translations.forEach((t, index) => {
            if (!grouped[t.type]) grouped[t.type] = [];
            grouped[t.type].push({ ...t, index: index + 1 });
        });

        let html = `
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number">${translations.length}</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #C9F2A0, #AEE5FF);">
                    <div class="stat-number">${Object.keys(grouped).length}</div>
                    <div class="stat-label">–¢–∏–ø–æ–≤ –ø–µ—Ä–µ–≤–æ–¥–∞</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #E5FFCF, #C5F0FF);">
                    <div class="stat-number">${translations.filter(t => t.confidence > 70).length}</div>
                    <div class="stat-label">–ü–æ–ø—É–ª—è—Ä–Ω—ã—Ö</div>
                </div>
            </div>
        `;

        if (translations.length > 0) {
            const main = translations[0];
            const enTermMain = sourceLang === 'en' ? originalText : (targetLang === 'en' ? main.text : '');
            const enMainAdded = enTermMain && studySet.has(enTermMain.toLowerCase());

            html += `
                <div class="main-translation">
                    <div class="original-text">${escapeHTML(originalText)}</div>
                    <div class="main-result">${escapeHTML(main.text)}</div>
                    <div style="margin-top: 10px; color: var(--muted); font-size: 14px;">
                        –û—Å–Ω–æ–≤–Ω–æ–π –ø–µ—Ä–µ–≤–æ–¥ ‚Ä¢ ${escapeHTML(main.source)} ‚Ä¢ ${main.confidence}% —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
                    </div>
                    ${enTermMain ? `
                        <div class="main-actions">
                            <button
                                class="add-btn ${enMainAdded ? 'added' : ''}"
                                title="–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑—É—á–µ–Ω–∏–µ (–∞–Ω–≥–ª.)"
                                data-term="${encodeURIComponent(enTermMain)}"
                                data-chosen="${encodeURIComponent(targetLang === 'en' ? main.text : originalText)}"
                                data-original="${encodeURIComponent(originalText)}"
                                data-source="${encodeURIComponent(main.source)}"
                                data-confidence="${main.confidence || ''}"
                                data-where="main"
                                onclick="handleAddClick(event)"
                            >
                                ${enMainAdded ? '‚úì –î–æ–±–∞–≤–ª–µ–Ω–æ' : '‚ûï –í –∏–∑—É—á–µ–Ω–∏–µ'}
                            </button>
                        </div>
                    ` : ``}
                </div>
            `;
        }

        html += `
            <div class="section-title">–í—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–µ—Ä–µ–≤–æ–¥–∞ <span class="count-badge">${translations.length}</span></div>
            <div class="translations-grid">
        `;

        Object.entries(grouped).forEach(([type, items]) => {
            const title = type.charAt(0).toUpperCase() + type.slice(1);
            html += `
                <div class="translation-group">
                    <div class="group-header">
                        <span>${escapeHTML(title)}</span>
                        <span style="color: var(--muted); font-size: 14px;">${items.length} –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤</span>
                    </div>
                    <div class="translation-list">
            `;
            items.forEach(item => {
                const enTerm = targetLang === 'en' ? item.text : (sourceLang === 'en' ? originalText : '');
                const enAdded = enTerm && studySet.has(enTerm.toLowerCase());

                html += `
                    <div class="translation-item" onclick="copyText('${escapeHTML(item.text).replace(/'/g, "\\'")}')">
                        <div class="translation-number">${item.index}</div>
                        <div style="flex: 1; min-width: 0;">
                            <div class="translation-text">${escapeHTML(item.text)}</div>
                            <div class="translation-info">${escapeHTML(item.source)} ‚Ä¢ ${item.confidence}% —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</div>
                        </div>
                        ${enTerm ? `
                            <button
                                class="add-btn ${enAdded ? 'added' : ''}"
                                title="–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑—É—á–µ–Ω–∏–µ (–∞–Ω–≥–ª.)"
                                data-term="${encodeURIComponent(enTerm)}"
                                data-chosen="${encodeURIComponent(targetLang === 'en' ? item.text : originalText)}"
                                data-original="${encodeURIComponent(originalText)}"
                                data-source="${encodeURIComponent(item.source)}"
                                data-confidence="${item.confidence || ''}"
                                data-where="list"
                                onclick="handleAddClick(event)"
                            >
                                ${enAdded ? '‚úì' : '‚ûï'}
                            </button>
                        ` : ``}
                    </div>
                `;
            });
            html += `</div></div>`;
        });

        html += `</div>`;

        html += `
            <div class="context-examples">
                <div class="section-title">–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</div>
                <div id="examples-container">
                    <div class="examples-loading">–ò—â—É —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã...</div>
                </div>
            </div>
        `;

        resultsDiv.innerHTML = html;
        resultsDiv.classList.add('active');

        const exContainer = document.getElementById('examples-container');
        try {
            const mainTr = translations[0]?.text || '';
            const examples = await getRealExamples(originalText, mainTr);
            if (!examples.length) {
                exContainer.innerHTML = `<div class="examples-empty">–ü—Ä–∏–º–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã üòï</div>`;
            } else {
                exContainer.innerHTML = examples.map(ex => `
                    <div class="example-card">
                        <div class="example-source">${ex.source}</div>
                        <div class="example-target">${ex.target}</div>
                    </div>
                `).join('');
            }
        } catch (e) {
            console.error(e);
            exContainer.innerHTML = `<div class="examples-error">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã</div>`;
        }
    }

    function copyText(text) {
        navigator.clipboard.writeText(text).then(() => {
            showToast(`–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ: ${text}`);
        });
    }

    function showError(message) {
        const errorDiv = document.getElementById('error');
        errorDiv.textContent = message;
        errorDiv.classList.add('active');
        setTimeout(() => errorDiv.classList.remove('active'), 3000);
    }
</script>
</body>
</html>
